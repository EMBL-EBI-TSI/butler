upstream chronograf {
	server influxdb.service.consul:8888;
}

upstream rabbitmq {
	server rabbitmq.service.consul:15672;
}

upstream airflow {
	server airflow.service.consul:8889;
}

upstream flower {
	server airflow.service.consul:5555;
}

upstream grafana {
	server grafana.service.consul:3000;
}

upstream kibana {
	server kibana.service.consul:5601;
}

upstream consul {
	server consul-ui.service.consul:8500;
}
upstream airflow-sub {
        server airflow-sub.service.consul:8091;
}

server {
        listen 8091;

        index index.html index.htm;
        server_name airflow-sub.service.consul;

        location / {
                proxy_pass http://airflow/;
                proxy_set_header Host $host:$server_port;
                proxy_set_header X-Real_IP $remote_addr;
                proxy_set_header X-Forwarded-For $remote_addr;
        }

}

server {
	listen 8090;
	
	root /opt/butler/web/html;
	index index.html index.htm;
	server_name _;
	
	location / {
    	try_files $uri $uri/ / =404;
	}
	
	location ^~ /chronograf/ {
        proxy_pass http://chronograf/;
        proxy_set_header Host $host;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
	}
	
	location ^~ /rabbitmq/ {
        proxy_pass http://rabbitmq/;
        proxy_set_header Host $host;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
	}
	
	location ^~ /flower/ {
        proxy_pass http://flower/;
        rewrite ^/flower/(.*)$ /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
	}
	
	location ^~ /airflow/ {
        proxy_pass http://airflow-sub/;
        proxy_set_header Host $host;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        rewrite /airflow/(.*) /$1 break;
	
	location ^~ /grafana/ {
		proxy_pass http://grafana/;
		proxy_set_header Host $host;
		proxy_set_header X-Real_IP $remote_addr;
		proxy_set_header X-Forwarded-For $remote_addr;
	}
	
	location ^~ /kibana/ {
		proxy_pass http://kibana/;
		proxy_set_header Host $host;
		proxy_set_header X-Real_IP $remote_addr;
		proxy_set_header X-Forwarded-For $remote_addr;
		rewrite /kibana/(.*) /$1 break;
	}
	
	location ^~ /consul/ {
		proxy_pass http://consul/;
		proxy_set_header Host $host;
		proxy_set_header X-Real_IP $remote_addr;
		proxy_set_header X-Forwarded-For $remote_addr;
	}
}